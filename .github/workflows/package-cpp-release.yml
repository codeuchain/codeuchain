name: Package C++ Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to package'
        required: true
        default: '1.0.0'

permissions:
  contents: write  # Required to upload release assets

jobs:
  package-cpp:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Upload release assets
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Setup C++ compiler
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 11
          platform: x64

      - name: Generate clean C++ release package
        run: |
          # Use packaging script to create standalone release directory and archives
          chmod +x scripts/package_cpp_release.sh
          ./scripts/package_cpp_release.sh v${{ github.event.inputs.version || '1.0.0' }}
          
          echo "✅ Clean release package created"
          ls -lh releases/codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}*

      - name: Build and test standalone package
        run: |
          # Extract archive to test location
          cd /tmp
          tar -xzf $GITHUB_WORKSPACE/releases/codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}.tar.gz
          
          # Build using the standalone package
          cd codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}
          chmod +x build.sh
          ./build.sh
          
          # Run a quick test
          ./build/examples/simple_math
          
          # Run unit tests
          cd build
          ctest --output-on-failure
          
          echo "✅ Standalone package builds and tests successfully!"

      - name: Verify archives are clean (no build artifacts)
        run: |
          echo "Checking archive contents..."
          tar -tzf releases/codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}.tar.gz | grep -E '\.(o|a|so|dll|exe)$' && echo "❌ Build artifacts found in archive!" && exit 1 || echo "✅ Archive is clean"
          tar -tzf releases/codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}.tar.gz | grep 'build/' && echo "❌ Build directory found in archive!" && exit 1 || echo "✅ No build directory"
          tar -tzf releases/codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}.tar.gz | grep '\._' && echo "⚠️ macOS metadata files found" || echo "✅ No macOS metadata files"
          echo "Archive verification complete"

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: |
            releases/codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}.tar.gz
            releases/codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        if: github.event_name == 'workflow_dispatch'
        with:
          name: codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}
          path: |
            releases/codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}.tar.gz
            releases/codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}.zip

  validate-package:
    needs: package-cpp
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Only needs to read artifacts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Setup C++ compiler
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 11
          platform: x64
          
      - name: Download artifact
        uses: actions/download-artifact@v4
        if: github.event_name == 'workflow_dispatch'
        with:
          name: codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}

      - name: Extract and validate structure
        run: |
          # Extract tar.gz
          tar -xzf codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}.tar.gz

          # Check structure
          echo "Package contents:"
          ls -lah codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}/

          # Verify essential files exist
          test -f codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}/CMakeLists.txt
          test -d codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}/include
          test -d codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}/src
          test -d codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}/examples
          test -f codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}/build.sh
          test -f codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}/USAGE.md
          test -f codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}/README.md
          test -f codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}/conanfile.py

          echo "✅ Package structure validated successfully!"
          
      - name: Build standalone package
        run: |
          cd codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}
          chmod +x build.sh
          ./build.sh
          
      - name: Test standalone package
        run: |
          cd codeuchain-cpp-v${{ github.event.inputs.version || '1.0.0' }}
          
          # Run examples
          echo "Testing examples..."
          ./build/examples/simple_math
          ./build/examples/typed_context_example
          
          # Run unit tests
          echo "Running unit tests..."
          cd build
          ctest --output-on-failure
          
          echo "✅ All validation tests passed!"